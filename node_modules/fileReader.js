var fs = require("fs"),
	path = require('path'),
	mime = require('mime')

function readFile(dir, callback) {
	var result = {
		files: [],
		status: 0,
		error: [],
		msg: []
	}
	fs.readdir(dir, function(error, files) {
		if (error) {
			logger.error(error)
			result.status = 500
			result.error = [error.toString()]
		} else {
			// 读取信息
			var isProject = fs.existsSync(path.join(dir, "fekit.config"))
			storage.set("path", dir)
			for (var i = 0; i < files.length; ++i) {
				var fname = path.join(dir, files[i]),
					state = mime.stat(fname)
				state._type = state.type
				if(state.type === "folder") {
					var fkitcfg = fname + "\\" + "fekit.config";
					if (fs.existsSync(fkitcfg)) {
						state.isProject = fkitcfg; 
						state._type = "fekit";
					}
				}
				result.files.push(state)
			}
		}
		callback && callback(result)
	})
}

$eventManager.$watch("explore", function(data) {
	var path = data.path,
		callback = data.callback || noop
	readFile(path, callback)
})