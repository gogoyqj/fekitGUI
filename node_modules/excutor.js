// 执行命令函数
var spawn = require("child_process").spawn,
	supportRunner = {}

// 接到命令
/*
	{
		runner: "fekit" // or "oniui"
		cmd: "install xxx" // or "install xxx" or "[fekit] oniui install xxx"
		cwd: path// 目录
	}
 */
$eventManager.$watch("cmd", function(data) {
	var runner = data.runner,
		callback = data.callback || function() {}
	// check command
	if(!supportRunner[runner]) {
		logger.log("[LOG] checking " + runner)
		checkCommand(data, function(result) {
			if(result) {
				logger.success(runner + " is installed")
				supportRunner[runner] = true
				logger.log("executing " + runner + " " + data.cmd + "...")
				excute(data, callback)
			} else {
				logger.error(runner + " is uninstalled")
				callback({
					status: 600,
					error: [runner + " is uninstalled"]
				})
			}
		})
	}
})

$eventManager.$watch("getDisk", function(data) {
	runCommandsShell("getDisk", {}, function(result) {
		data && data.callback && data.callback(result)
	})
})

// // 执行命令
function excute(data, callback) {
	var result = {
			msg: [], 
			pids: [], 
			status: 0, 
			data: data, 
			error: []}, run
	try {
		run = spawn(data.runner, [], {
			cwd: data && data.cwd || targetDir || installDir
		})
		// 出错
		run.stderr.on("data", function(data) {
			result.error.push(data.toString())
			result.status = 250
			callback(result)
		})
		// 输出数据
		run.stdout.on("data", function(data) {
			var info = data.toString(), pid
			// 提取log里包含的pid
			if(pid = info.match(/pid=[0-9]+/g)) {
				pid.forEach(function(value, index) {
					pid[index] = value.replace(/[^0-9]+/g, "")
				})
				return result.pids = result.pids.concat(pid)
			}
			result.msg.push(info)
			// 及时输出log
			logger.log(data.toString())
		})
		// 关闭
		run.on("close", function(code, signal) {
			result.status = code
			result.msg.push(code + " " + signal)
			callback(result)
		})
		result.process = run
	} catch(e) {
		result.status = 300
		result.error.push(e.toString())
		callback(result)
	}
}
// // 执行commands里的shell命令
function runCommandsShell(shell, data, callback) {
	excute({
		runner: installDir + "/commands/" + shell + isWindows,
		cmd: data && data.runner,
		cwd: data && data.cwd
	}, callback)
}
// check cmd
function checkCommand(data, callback) {
	runCommandsShell("getCMD", data, function(result) {
		var msg = result.msg.join("---"),
			runner = data.runner
		if(result.status || !msg.match(runner)) {
			callback(false)
		} else {
			callback(true)
		}
	})
}